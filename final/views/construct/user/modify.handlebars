<h4></h4>
<div class="container" id="modifyInfoDiv">
    <div class="col-6 offset-3">
    <p id="error">{{error}}</p>
    <form id="modifyInfoForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="changePor">Your Avatar:</label></br>
            <img id="PortraitNow" class="mr-3 rounded-circle" src="/public/image/portrait/{{portrait}}" width="100" height="100" alt="headPortrait"></br></br>
            <button id="changePor" type="button" data-toggle="modal" data-target="#modifyPortraitDia" class="btn btn-primary">Change your Avatar:</button>
        </div>
        <div class="form-group">
            <label for="modifyUser">User Name:</label>
            <input id="modifyUser" class="form-control" type="text" name="userName" value={{user}} disabled></br>
        </div>
        <div class="form-group">
            <label for="changePas">Password:</label></br>
            <button id="changePas" type="button" data-toggle="modal" data-target="#modifyPasswordDia" class="btn btn-primary">Change your Password</button>
        </div>
        <div class="form-group">
            <label for="modifyFirst">First Name:</label>
            <input id="modifyFirst" class="form-control" type="text" name="firstName" value={{first}} required></br>
        </div>
        <div class="form-group">
            <label for="modifyLast">Last Name:</label>
            <input id="modifyLast" class="form-control" type="text" name="lastName" value={{last}} required></br>
        </div>
        <div class="form-group">
            <label for="modifyEmail">Email:</label>
            <input id="modifyEmail" class="form-control" type="email" name="email" value={{email}} required></br>
        </div>
        <button type="submit" id="modifySubmit" data-toggle="modal" data-target="#modifyinfoDia" class="btn btn-primary">Submit</button>
    </form>
    </div>
</div>

<div class="modal fade" id="modifyinfoDia" tabindex="-1" role="dialog" aria-labelledby="modifyinfoDiaTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" id="modifyinfoDiaHeader">
                <h5 class="modal-title" id="modifyinfoDiaTitle">Change Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modifyinfoDiaBody">
                Do you want to change your profile?
            </div>
            <div class="modal-footer" id="modifyinfoDiaFooter">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="nomodify">No</button>
                <button type="button" class="btn btn-primary" id="yesmodify" >Yes</button>
            </div>
        </div>
    </div>
</div> 
<div class="modal fade" id="modifyPasswordDia" tabindex="-1" role="dialog" aria-labelledby="modifyPasswordDiaTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" id="modifyPasswordDiaHeader">
                <h5 class="modal-title" id="modifyPasswordDiaTitle">Modify Password</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modifyPasswordDiaBody">
                <div class="form-group">
                    <label for="modifyPassword">Password:</label>
                    <input id="modifyPassword" class="form-control" type="password" name="password" required></br>
                </div>
                <div class="form-group">
                    <label for="modifyConPassword">Confirm Password:</label>
                    <input id="modifyConPassword" type="password" name="conPassword" class="form-control" placeholder="Confirm" required>
                </div>
            </div>
            <div class="modal-footer" id="modifyPasswordDiaFooter">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="noPasMod">Close</button>
                <button type="button" class="btn btn-primary" id="yesPasMod" disabled="true">Modify</button>
            </div>
        </div>
    </div>
</div> 
<div class="modal fade" id="modifyPortraitDia" tabindex="-1" role="dialog" aria-labelledby="modifyPortraitDiaTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" id="modifyPortraitDiaHeader">
                <h5 class="modal-title" id="modifyPortraitDiaTitle">Modify Avatar</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modifyPortraitDiaBody">
                <div class="container" id="avatarArea">
                    <div class="row h-100">
                        <div class="col align-self-center text-center" id="dragarea">
                            Drag your avatar here...
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="modifyPortrait" name="portrait" accept="image/*" required>
                        <label id="fileNameLabel" class="custom-file-label" for="modifyPortrait">Your Avatar...</label>
                    </div>
                </div>
                <div class="container" id="fileRestrict">
                    <p style="color:red;">You should upload your avatar</p>
                </div>
            </div>
            <div class="modal-footer" id="modifyPortraitDiaFooter">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="noPorMod">Close</button>
                <button type="button" class="btn btn-primary" id="yesPorMod" disabled="true">Modify</button>
            </div>
        </div>
    </div>
</div> 

<script src="/public/js/filesizelimit.js"></script>
<script type="text/javascript">
    var uploadhead = false;
    var empty = false;
    var emailValid = false;
    var passwordMin = false;
    var passwordMax = false;
    var conpassMatch = false;
    var file;
    var portraitModified = false;
    var passwordModified = false;
    var tempFile;
    $(document).on({
        dragleave:function(e){
            e.preventDefault();
            $('#dragarea').removeClass('over');
        },
        drop:function(e){
            e.preventDefault();
            //$('#dragarea').removeClass('over');
        },
        dragenter:function(e){
            e.preventDefault();
            $('#dragarea').addClass('over');
        },
        dragover:function(e){
            e.preventDefault();
            $('#dragarea').addClass('over');
        }
    });
    document.getElementById('dragarea').addEventListener("drop", function(e) {
        e.preventDefault();
        file = e.dataTransfer.files[0];
        if (file == undefined) {
            return false;
        }
        if (file.type.indexOf('image') === -1) {
            $("#fileRestrict").find('p').text("You should drag the image to the area!");
            $("#fileRestrict").find('p').css('color', 'red');
            return false;
        }
        var fun = checkSize;
        var sizeOk = fun(e.dataTransfer);
        if(!sizeOk) { 
            var fileName = file.name;
            $("#fileRestrict").find('p').text("The maximum file size is 2M. It's too large!");
            $("#fileRestrict").find('p').css('color', 'red');
            uploadhead = false;
        }
        else{
            var fileName = file.name;
            $('#fileNameLabel').text(fileName);
            $("#fileRestrict").find('p').text("");
            imgPreview();
            uploadhead = true;
            $('modifyPortrait').val(e.dataTransfer);
        }
        if(uploadhead)
            $("#yesPorMod").attr('disabled', false);
        else
            $("#yesPorMod").attr('disabled', true);
    }, false);
    $("#modifyPortrait").change(function() {
        file = this.files[0];
        var fun = checkSize;
        var sizeOk = fun(this);
        if($(this).val() !== '') {
            if(!sizeOk) { 
                var fileName = file.name;
                $("#fileRestrict").find('p').text("The maximum file size is 2M. It's too large!");
                $("#fileRestrict").find('p').css('color', 'red');
                uploadhead = false;
            }
            else{
                var fileName = file.name;
                $('#fileNameLabel').text(fileName);
                $("#fileRestrict").find('p').text("");
                imgPreview();
                uploadhead = true;
            }
        }
        else {
            $('#dragarea').text("Drag your avatar here...")
            $('#fileNameLabel').text("Your Avatar...");
            $("#fileRestrict").find('p').text("You should upload your avatar");
            $("#fileRestrict").find('p').css('color', 'red');
            uploadhead = false;
        }
        if(uploadhead)
            $("#yesPorMod").attr('disabled', false);
        else
            $("#yesPorMod").attr('disabled', true);
    });
    function imgPreview() {
        var reader;
        if(window.FileReader) {
            reader = new FileReader();
        } else {
            $("#fileRestrict").find('p').text("Your device doesn't support image preview!");
            $("#fileRestrict").find('p').css('color', 'red');
            return;
        }
        reader.onload = function(e) {
            document.getElementById("dragarea").innerHTML = '<img src="' + e.target.result + '" width="200px" height="200px" />'
            tempFile = e.target.result;
        }
        reader.readAsDataURL(file);
    }
    $('#modifyInfoForm').submit(function(){
        window.event.preventDefault();
        $(this).find(':button[type=submit]').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
        $(this).find(':button[type=submit]').prop('disabled', true);
    });
    $("#nomodify").click(function() {
        $('#modifySubmit').html('Submit');
        $('#modifySubmit').attr('disabled', false);
    });
    $(document).ready(function(){
        empty = true;
        emailValid = true;
        passwordMin = false;
        passwordMax = false;
        conpassMatch = false;
        portraitModified = false;
        passwordModified = false;
    }); 
    bootstrapValidate(['#modifyFirst', '#modifyLast', '#modifyEmail'], 'required: This can not be empty!', function(isEmpty) {
        if(isEmpty == true) {
            empty = true; 
            if(empty && emailValid)
                $("#modifySubmit").attr('disabled', false);
            else
                $("#modifySubmit").attr('disabled', true);
        } 
        else 
        if(isEmpty == 0) {
            empty = false;
            $("#modifySubmit").attr('disabled', true);
        }
    });
    bootstrapValidate('#modifyEmail', 'email: Enter a valid E-Mail!', function(isEmail) { if(isEmail) {emailValid = true; if(empty && emailValid)
        $("#modifySubmit").attr('disabled', false); else
        $("#modifySubmit").attr('disabled', true); } else {emailValid = false; $("#modifySubmit").attr('disabled', "true");}});
    bootstrapValidate('#modifyPassword', 'min:6: Your password should more than 6 charactors!', function(isPassword) { if(isPassword) {passwordMin = true; if(passwordMax && passwordMin && conpassMatch)
        $("#yesPasMod").attr('disabled', false); else
        $("#yesPasMod").attr('disabled', true);} else {passwordMin = false; $("#yesPasMod").attr('disabled', "true");}});
    bootstrapValidate('#modifyPassword', 'max:20: Your password should no more than 20 charactors!', function(isPassword) { if(isPassword) {passwordMax = true; if(passwordMax && passwordMin && conpassMatch)
        $("#yesPasMod").attr('disabled', false); else
        $("#yesPasMod").attr('disabled', true);} else {passwordMax = false; $("#yesPasMod").attr('disabled', "true");}});
    bootstrapValidate('#modifyConPassword', 'matches: #modifyPassword: The password is not match!', function(isMatched) { if(isMatched) {conpassMatch = true; if(passwordMax && passwordMin && conpassMatch)
        $("#yesPasMod").attr('disabled', false); else
        $("#yesPasMod").attr('disabled', true);} else {conpassMatch = false; $("#yesPasMod").attr('disabled', "true");}});
    $("#yesPorMod").click(function() {
        var reader;
        if(window.FileReader) {
            reader = new FileReader();
        } else {
            document.getElementById("fileRestrict").innerHTML = '<div class="alert alert-danger" role="alert">\
                Your device doesn\'t support the image preview!\
            </div>'
            return;
        }
        reader.onload = function(e) {
            $('#PortraitNow').attr('src', tempFile);
        }
        reader.readAsDataURL(file);
        portraitModified = true;
        $('#modifyPortraitDia').modal('hide');
    });

    $("#yesPasMod").click(function() {
        passwordModified = true;
        $('#modifyPasswordDia').modal('hide');
    });
    
    $("#yesmodify").click(function() {
        $("#yesmodify").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
        $('#yesmodify').prop('disabled', true);
        var formData = new FormData();
        if(portraitModified)
            formData.append('portrait', file);
        formData.append('username', $("#modifyUser").val());
        if(passwordModified) {
            formData.append('password', $("#modifyPassword").val());
            formData.append('conPassword', $("#modifyConPassword").val());
        }
        formData.append('firstName', $("#modifyFirst").val());
        formData.append('lastName', $("#modifyLast").val());
        formData.append('email', $("#modifyEmail").val());

        $.ajax({
            type: "post",
            url: "/modifyInfo",
            dataType: "json",
            data: formData,
            contentType: false,
            processData: false,
            success: function(res) {
                $("#modifyinfoDiaFooter").hide();
                $("#modifyinfoDiaBody").html('<div class="container"><p>Profile changed for user ' + res["user"] + '!</p></br><span id="totalSecond">5</span><span id="second"> Seconds</span><span id="nextcontent"> later to go back homepage!</span></div>');
                jQuery.getScript("/public/js/autourl.js").done(function(){
                    var fun = auto;
                    fun("/");
                })
            },
            error: function(err) {
                $("#modifyinfoDiaFooter").hide();
                $("#modifyinfoDiaBody").html('<div class="container"><p>Profile change failed for user ' + err["user"] + '!</p></br><span id="totalSecond">5</span><span id="second"> Seconds</span><span id="nextcontent"> later to go back homepage!</span></div>');
                jQuery.getScript("/public/js/autourl.js").done(function(){
                    var fun = auto;
                    fun("/");
                })
            }
        });
    })
</script>